name: Playwright Tests (3o3)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # 1시간마다 스케줄 실행 (UTC 기준)
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

env:
  NODE_ENV: test
  CI: true
  # GitHub Pages에 배포되는 HTML 리포트 URL (본인 레포에 맞게 유지)
  PLAYWRIGHT_REPORT_PAGES_URL: https://salaryman91.github.io/3o3/

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1) 레포 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Node.js 세팅
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3) 의존성 설치
      - name: Install dependencies
        run: npm ci

      # 4) Playwright 브라우저 설치
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # 5) Playwright 테스트 실행 + 요약 로그 저장
      - name: Run Playwright tests
        id: playwright
        run: |
          set -o pipefail
          npx playwright test | tee playwright-summary.log

      # 6) 결과 파싱 + meta.json / screenshots/map.txt 생성
      - name: Collect results (meta.json, screenshots/map.txt)
        if: always()
        continue-on-error: true
        env:
          CI_STATUS: ${{ job.status }}
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
        run: node scripts/ci/collect-results.mjs

      # 7) HTML 리포트 artifact 업로드
      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      # 8) test-results artifact 업로드 (실패 시만)
      - name: Upload raw test-results (screenshots/trace)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          if-no-files-found: ignore
          retention-days: 7

      # 9) GitHub Pages 배포 (HTML 리포트 + 스크린샷)
      - name: Deploy Playwright report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./playwright-report

      # 10) Slack 알림 (성공/실패 모두)
      - name: Notify Slack
        if: always()
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: node scripts/ci/notify-slack.mjs
